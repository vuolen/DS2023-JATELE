<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <title>JATELE</title>
  </head>
  <body>
    <h1>JATELE</h1>
    <textarea readonly></textarea>
    <input type="text" placeholder="Enter your message here..." />
    <div id="debug"></div>
  </body>
  <script>
    const textarea = document.querySelector("textarea");
    const input = document.querySelector("input");
    const debug = document.querySelector("#debug");

    const keepActive = (id) => {
      fetch("http://localhost:3000/active", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ id }),
      });
    };

    const peer = new Peer(null, {
      host: "localhost",
      port: 3000,
      path: "/peer",
      iceServers: [],
    });
    peer.on("open", async (id) => {
      console.log("My peer ID is: " + id);

      keepActive(id);
      setInterval(() => keepActive(id), 5000);

      const d = await fetch("http://localhost:3000/", {
        headers: {
          "Content-Type": "application/json",
        },
      });

      d.json().then((data) => {
        data["clients"].forEach((id) => {
          let connection = peer.connect(id);
          console.log("Connecting to ", id);
          connection.on("open", () => {
            console.info("Connected to ", id);
            connection.send("hi!");
          });

          connection.on("data", (data) => {
            console.info("DATA!", data);
            addToTextArea(data);
          });

          connection.on("error", (err) => {
            console.error(err);
            connection.close();
          });

          connection.on("close", () => {
            connection.close();
          });
        });
      });
    });

    setInterval(() => {
      debug.innerHTML = "My ID" + peer.id + "<br>";
      debug.innerHTML += peer.open ? "PeerJS open" : "PeerJS closed";
      debug.innerHTML += "<br>Connections " + peer._connections.size;
      debug.innerHTML += "<br>Event count " + peer._eventsCount;
    }, 500);

    const addToTextArea = (text) => {
      textarea.value += "\n" + text;
      textarea.scrollTop = textarea.scrollHeight;
    };

    input.addEventListener("keyup", (e) => {
      if (e.key === "Enter" && input.value.length > 0) {
        addToTextArea(input.value);
        input.value = "";
      }
    });
  </script>
  <style type="text/css">
    body {
      display: flex;
      flex-direction: column;
    }
    textarea {
      height: 40vh;
    }
    input {
      padding: 5px;
    }
  </style>
</html>
